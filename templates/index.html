<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procreate Stamp Converter</title>
    <style>
        /* All CSS is unchanged and correct */
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #EAEAEA; color: #000000; margin: 0; padding: 40px 20px; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .main-title { font-size: 18px; font-weight: 500; margin-bottom: 20px; letter-spacing: 0.8px; text-align: center; line-height: 1.2; }
        .converter-card { background-color: #FFFFFF; border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); width: 100%; max-width: 400px; padding: 24px; box-sizing: border-box; margin-bottom: 20px; }
        .step-label { font-size: 16px; font-weight: 500; margin-bottom: 12px; }
        input[type="text"] { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 12px; box-sizing: border-box; background-color: #2D2D2D; color: #FFFFFF; text-align: center; margin-bottom: 12px; font-weight: 400; }
        .balance-status { text-align: center; font-size: 14px; color: #333; margin-bottom: 24px; margin-top: -12px; padding: 10px; border-radius: 8px; background-color: #e2e3e5; display: none; }
        .balance-status.error { background-color: #f8d7da; color: #721c24; }
        .balance-status.success { background-color: #d4edda; color: #155724; }
        .upload-area-label { display: block; }
        .upload-area { border: 2px dashed #D0D0D0; border-radius: 16px; padding: 30px; text-align: center; transition: all 0.2s ease; }
        .upload-area:hover:not(.disabled) { border-color: #999; }
        .upload-area.disabled { cursor: not-allowed; background-color: #f8f9fa; border-color: #e9ecef; }
        .upload-area.disabled svg path { stroke: #ced4da; }
        .upload-area.disabled p { color: #adb5bd; }
        .upload-area svg { margin-bottom: 12px; transition: stroke 0.2s ease; }
        .upload-area p { color: #666; font-size: 14px; margin: 4px 0 0 0; font-weight: 400; transition: color 0.2s ease; }
        .file-list { margin-top: 10px; font-size: 14px; color: #666; text-align: left; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; display: none; margin-bottom: 20px; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .file-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
        .file-list-item .status { font-weight: 500; margin-left: 10px; }
        .status-pending { color: #888; }
        .status-processing { color: #007bff; }
        .status-completed { color: #28a745; }
        .status-failed { color: #dc3545; }
        .remove-file-btn { cursor: pointer; color: #aaa; font-weight: bold; font-size: 20px; padding: 0 5px; line-height: 1; }
        .remove-file-btn:hover { color: #333; }
        .submit-button { width: 100%; padding: 16px; font-size: 16px; font-weight: 500; border-radius: 12px; border: none; cursor: pointer; background-color: #2D2D2D; color: #FFFFFF; transition: background-color 0.2s ease; margin-top: 20px; }
        .submit-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .info-text { text-align: center; font-size: 14px; color: #555; margin-top: 16px; }
        .message-area { padding: 12px; margin-bottom: 20px; border-radius: 8px; text-align: center; font-size: 14px; font-weight: 400; display: none; background-color: #e2e3e5; color: #383d41; }
        .get-token-section { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .get-token-section p { font-size: 16px; color: #333; margin-bottom: 12px; font-weight: 400; }
        .get-token-button { display: inline-block; padding: 14px 28px; font-size: 16px; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; background-color: #00AEEF; color: #FFFFFF; text-decoration: none; transition: background-color 0.2s ease; }
        .get-token-button:hover { background-color: #0099d4; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #D0D0D0; text-align: center; font-size: 12px; color: #666; width: 100%; max-width: 400px; }
        .footer a { color: #666; text-decoration: none; margin: 0 8px; font-weight: 400; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px; border: 1px solid #888; border-radius: 16px; width: 90%; max-width: 500px; position: relative; font-size: 14px; line-height: 1.6; color: #333; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; }
        #errorModal .modal-content { border-top: 5px solid #dc3545; }
        #errorModal h2 { color: #dc3545; }
    </style>
</head>
<body>
    <h1 class="main-title">PROCREATE STAMP TO PNG CONVERTER</h1>

    <div class="converter-card">
        <form id="uploadForm" novalidate>
            <!-- Step 1: License Key -->
            <p class="step-label">Step 1: Enter Your License Key</p>
            <input type="text" id="license_key" name="license_key" placeholder="Enter your license key here">
            <div class="balance-status" id="balanceStatus"></div>

            <!-- Step 2: Upload -->
            <p class="step-label">Step 2: Upload Your .brushset Files</p>
            <label for="brush_files" class="upload-area-label" id="uploadAreaLabel">
                <div class="upload-area disabled" id="uploadArea">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#D0D0D0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 2V8H20" stroke="#D0D0D0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 18V12" stroke="#D0D0D0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 15L12 12L15 15" stroke="#D0D0D0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <p><span style="color: #000; font-weight: 500; text-decoration: underline;">Click to upload</span> or drag and drop</p>
                    <p>1 or more .brushset files / 50MB total per session</p>
                </div>
            </label>
            <input type="file" id="brush_files" name="brush_files" accept=".brushset" multiple style="display: none;" disabled>
            <div class="file-list" id="fileList"></div>
            <div class="message-area" id="messageArea"></div>

            <!-- Convert Button and Info Text -->
            <button type="submit" class="submit-button" id="submitBtn" disabled>Convert Your Brushsets</button>
            <p class="info-text">This tool extracts stamp images (min 1024px  ). It does not convert complex brush textures.</p>

            <!-- Buy Credits Section -->
            <div class="get-token-section">
                <p>Don't have a license key?</p>
                <a href="https://presentandcherish.lemonsqueezy.com/buy/9fac6a82-c127-4b2e-845d-dec42c9f33ce" target="_blank" class="get-token-button" id="buyBtn">Buy Credits Here</a>
            </div>
        </form>
    </div>

    <footer class="footer">
        <p>&copy; 2025 PresentAndCherish. All rights reserved.</p>
        <p><a href="javascript:void(0 );" onclick="openModal('policyModal')">Terms & Privacy</a></p>
    </footer>

    <!-- Modals -->
    <div id="policyModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('policyModal')">&times;</span>
            <h2>Terms & Privacy</h2>
            <p><strong>Effective Date:</strong> 25 August 2025</p>
            <h3>Privacy Policy</h3>
            <p>We collect your License Key solely to validate your purchase and process your file conversion. This data is processed via our payment partner, Lemon Squeezy. We never store, sell, or share your details unless required by law.</p>
            <h3>Terms of Service</h3>
            <p>By using this service, you agree that you are the rightful owner of a valid license key. Service functionality depends on a valid key and correct file uploads. We are not responsible for conversion failures due to user error or technical issues beyond our reasonable control.</p>
        </div>
    </div>
    <div id="errorModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('errorModal')">&times;</span>
            <h2>An Error Occurred</h2>
            <p id="errorModalText"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const licenseKeyInput = document.getElementById('license_key');
            const balanceStatus = document.getElementById('balanceStatus');
            const fileInput = document.getElementById('brush_files');
            const fileListDisplay = document.getElementById('fileList');
            const submitBtn = document.getElementById('submitBtn');
            const uploadForm = document.getElementById('uploadForm');
            const uploadArea = document.getElementById('uploadArea');
            const uploadAreaLabel = document.getElementById('uploadAreaLabel');
            const messageArea = document.getElementById('messageArea');
            const errorModalText = document.getElementById('errorModalText');
            
            let selectedFiles = [];
            let isLicenseValid = false;
            let debounceTimer;
            let currentBalance = 0;

            window.openModal = (modalId) => document.getElementById(modalId).style.display = "block";
            window.closeModal = (modalId) => document.getElementById(modalId).style.display = "none";
            window.onclick = (event) => { if (event.target.classList.contains('modal-overlay')) event.target.style.display = "none"; };

            const showError = (text) => { errorModalText.textContent = text; openModal('errorModal'); };
            const showInfo = (text) => {
                messageArea.textContent = text;
                messageArea.style.display = 'block';
            };
            const resetMessages = () => {
                messageArea.style.display = 'none';
                messageArea.textContent = '';
            };

            const setUploadAreaEnabled = (enabled) => {
                fileInput.disabled = !enabled;
                if (enabled) {
                    uploadArea.classList.remove('disabled');
                    uploadAreaLabel.style.cursor = 'pointer';
                } else {
                    uploadArea.classList.add('disabled');
                    uploadAreaLabel.style.cursor = 'not-allowed';
                }
            };

            const checkSubmitButtonState = () => {
                submitBtn.disabled = !(isLicenseValid && selectedFiles.length > 0);
            };

            const checkBalance = async () => {
                const licenseKey = licenseKeyInput.value.trim();
                isLicenseValid = false;
                setUploadAreaEnabled(false);
                
                if (licenseKey.length < 8) {
                    balanceStatus.style.display = 'none';
                    checkSubmitButtonState();
                    return;
                }

                balanceStatus.textContent = 'Validating key...';
                balanceStatus.className = 'balance-status';
                balanceStatus.style.display = 'block';
                
                try {
                    const formData = new FormData();
                    formData.append('license_key', licenseKey);
                    const response = await fetch('/check-license', { method: 'POST', body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    currentBalance = result.remaining;
                    balanceStatus.innerHTML = `Valid Key! Remaining Conversions: <strong>${currentBalance}</strong>`;
                    balanceStatus.className = 'balance-status success';
                    isLicenseValid = currentBalance > 0;
                    setUploadAreaEnabled(isLicenseValid);
                    if (!isLicenseValid) {
                        balanceStatus.textContent = 'This key is valid, but has no conversions left.';
                        balanceStatus.className = 'balance-status error';
                    }
                } catch (error) {
                    balanceStatus.textContent = error.message;
                    balanceStatus.className = 'balance-status error';
                    isLicenseValid = false;
                    setUploadAreaEnabled(false);
                }
                checkSubmitButtonState();
            };

            const renderFileList = () => {
                fileListDisplay.innerHTML = '';
                if (selectedFiles.length > 0) {
                    fileListDisplay.style.display = 'block';
                    selectedFiles.forEach((file, index) => {
                        const item = document.createElement('div');
                        item.className = 'file-list-item';
                        item.innerHTML = `<span class="file-name">${file.name}</span><span class="status status-pending" id="status-${index}">Pending</span><span class="remove-file-btn" data-index="${index}">&times;</span>`;
                        fileListDisplay.appendChild(item);
                    });
                    document.querySelectorAll('.remove-file-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToRemove = parseInt(e.target.getAttribute('data-index'), 10);
                            selectedFiles.splice(indexToRemove, 1);
                            renderFileList();
                        });
                    });
                } else {
                    fileListDisplay.style.display = 'none';
                }
                checkSubmitButtonState();
            };

            const handleFiles = (files) => {
                if (fileInput.disabled) return;
                let currentFiles = Array.from(files);
                let errors = [];
                currentFiles.forEach(file => {
                    if (selectedFiles.length >= 10) { if (!errors.includes('You can upload a maximum of 10 files.')) errors.push('You can upload a maximum of 10 files.'); return; }
                    if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) return;
                    if (!file.name.toLowerCase().endsWith('.brushset')) { if (!errors.includes('Please select only .brushset files.')) errors.push('Please select only .brushset files.'); return; }
                    selectedFiles.push(file);
                });
                const totalSize = selectedFiles.reduce((acc, file) => acc + file.size, 0);
                if (totalSize > 50 * 1024 * 1024) {
                    errors.push('Total file size cannot exceed 50MB.');
                    selectedFiles.splice(selectedFiles.length - currentFiles.length);
                }
                if (errors.length > 0) showError(errors.join(' '));
                renderFileList();
            };

            licenseKeyInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                isLicenseValid = false;
                balanceStatus.style.display = 'none';
                setUploadAreaEnabled(false);
                checkSubmitButtonState();
                debounceTimer = setTimeout(checkBalance, 800);
            });

            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            uploadArea.addEventListener('dragover', (e) => { if (!fileInput.disabled) { e.preventDefault(); uploadArea.style.borderColor = '#999'; } });
            uploadArea.addEventListener('dragleave', (e) => { if (!fileInput.disabled) { e.preventDefault(); uploadArea.style.borderColor = '#D0D0D0'; } });
            uploadArea.addEventListener('drop', (e) => { if (!fileInput.disabled) { e.preventDefault(); uploadArea.style.borderColor = '#D0D0D0'; handleFiles(e.dataTransfer.files); } });

            uploadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (submitBtn.disabled) return;

                submitBtn.textContent = 'Converting...';
                submitBtn.disabled = true;
                setUploadAreaEnabled(false);
                showInfo('Starting conversion process...');
                
                const session_id = `session-${Date.now()}`;
                let hasFailed = false;

                (async () => {
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        if (hasFailed) break;
                        
                        const statusElem = document.getElementById(`status-${i}`);
                        const removeBtn = document.querySelector(`.remove-file-btn[data-index="${i}"]`);
                        if(removeBtn) removeBtn.style.display = 'none';
                        
                        statusElem.textContent = 'Processing...';
                        statusElem.className = 'status status-processing';
                        
                        const formData = new FormData();
                        formData.append('license_key', licenseKeyInput.value.trim());
                        formData.append('brush_file', file);
                        formData.append('session_id', session_id);
                        formData.append('is_first_file', (i === 0).toString());
                        formData.append('is_last_file', (i === selectedFiles.length - 1).toString());
                        formData.append('file_index', i.toString());
                        
                        try {
                            const response = await fetch('/convert-single', { method: 'POST', body: formData });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.message);
                            
                            statusElem.textContent = 'Completed';
                            statusElem.className = 'status status-completed';
                            
                            if (result.download_url) {
                                showInfo('All files processed! Your download will begin shortly.');
                                const a = document.createElement('a');
                                a.href = result.download_url;
                                a.download = 'Procreate_Stamps.zip';
                                document.body.appendChild(a);
                                a.click();
                                a.remove();
                                
                                if (result.remaining === -1) {
                                    currentBalance -= 1;
                                } else if (typeof result.remaining !== 'undefined' && result.remaining >= 0) {
                                    currentBalance = result.remaining;
                                }
                                
                                balanceStatus.innerHTML = `Valid Key! Remaining Conversions: <strong>${currentBalance}</strong>`;
                                isLicenseValid = currentBalance > 0;
                                if (!isLicenseValid) {
                                    balanceStatus.textContent = 'This key is valid, but has no conversions left.';
                                    balanceStatus.className = 'balance-status error';
                                }
                            }
                        } catch (error) {
                            statusElem.textContent = 'Failed';
                            statusElem.className = 'status status-failed';
                            showError(`Error: ${error.message}`);
                            hasFailed = true;
                        }
                    }

                    submitBtn.textContent = 'Convert Your Brushsets';
                    if (hasFailed) {
                        renderFileList();
                        setUploadAreaEnabled(true);
                    } else {
                        setTimeout(() => {
                            resetMessages();
                            selectedFiles = [];
                            renderFileList();
                            setUploadAreaEnabled(isLicenseValid);
                        }, 5000);
                    }
                    checkSubmitButtonState();
                })();
            });

            // Check for autofilled key on page load
            if (licenseKeyInput.value) {
                checkBalance();
            }
        });
    </script>
</body>
</html>
